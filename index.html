<html>

<head>
    <meta charset="UTF-8">
    <script src="jquery.min.js"></script>
    <script src='https://www.gstatic.com/firebasejs/3.0.3/firebase.js'></script>
    <script src="app.js"></script>
    <title>Firebase + Cloud Vision Stream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <script>
        var center;

        document.addEventListener('DOMContentLoaded', function() {
            var imagesList = document.getElementById('images'),
                textInput = document.getElementById('text'),
                sendButton = document.getElementById('send'),
                file = document.getElementById('file');



            // Handle file uploads to Storage
            function handleFileSelect(e) {
                $(".loading").toggle();
                e.preventDefault();

                // Try HTML5 geolocation.
                if ("geolocation" in navigator) {
                    // var location_timeout = setTimeout("alert('브라우저의 위치정보 수집이 불가합니다. 설정에서 승인 후 다시 시도해주세요.');", 10000);
                    navigator.geolocation.getCurrentPosition(function(position) {
                            center = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            var files = e.target.files,
                                i, file;
                            for (i = 0; file = files[i]; i++) {
                                var metadata = {
                                    'contentType': file.type,
                                };
                                var fileName = generateFilename(5);
                                var uploadTask = storage.ref().child('images/' + fileName).put(file, metadata);

                                uploadTask.on('state_changed', null, function(error) {
                                    alert('Upload failed:', error)
                                    console.log('Upload failed:', error)
                                    $(".loading").toggle();
                                }, function() {
                                    logPicture(fileName);
                                }.bind(uploadTask));
                            }

                        },
                        function() { //error callback
                            // clearTimeout(location_timeout);
                            $('#submitSection').text('disabled');
                            console.log("Error geolocation");
                            alert('브라우저의 위치정보 수집이 불가합니다. 설정에서 승인 후 다시 시도해주세요.');
                            // handleLocationError(true, infoWindow, map.getCenter());
                        }, {
                            timeout: 10000
                        });


                } else {
                    // Browser doesn't support Geolocation
                    console.log("Error geolocation; brower doesn't support");
                    alert('브라우저의 위치정보 수집이 불가합니다. 다른 브라우저에서 다시 시도해주세요.');
                    // handleLocationError(false, infoWindow, map.getCenter());
                }


                return false;
            }

            function logPicture(inFilename) {
                var pRef = firebase.database().ref("images/" + inFilename);

                pRef.set({
                    "latitude": center.lat,
                    "longitude": center.lng,
                    "status": -1,
                    "text": "",
                    "time": new Date().toString()
                }, function(error) {
                    if (error) {
                        console.log(error);
                    } else {
                        // when post to DB is successful 
                        alert('Upload succeeded!')
                        $(".loading").toggle();
                    }

                });

            }

            function generateFilename(inLength) {
                var text = [new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate()].join("-");
                var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

                for (var i = 0; i < inLength; i++)
                    text += possible.charAt(Math.floor(Math.random() * possible.length));

                return text;
            }

            file.addEventListener('change', handleFileSelect, false);
        });
    </script>

    <style>
        .loading {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Uploader UI demo</h1>
    <br>
    <h2>자동차 번호판의 사진을 올려주세요.</h2>
    <p>실시간 불법주차에 대한 수집이기 때문에 불법주차 차량을 발견 후 그 장소에서 즉시 올려주세요.</p>
    <p>한 사진당 한 번호판만 나오게 찍어주세요.</p>
    <p>번호판에 있는 글씨 외에는 다른 글씨가 안 보이게 찍어주세요.</p>
    예시) <img width="200" src="img/1.jpg" />
    <img width="200" src="img/2.jpg" />
    <ul id='images'></ul>
    <div id='footer'>
        <input type="file" id="file" name="file" />
        <p class="loading">Loading..</p>
    </div>
</body>

</html>